================================================================================
6-MONTH FREE SUBSCRIPTION SQL SCRIPT
For Companies & Professionals
================================================================================

INSTRUCTIONS:
1. Copy EVERYTHING below this line
2. Open your Supabase project dashboard
3. Go to SQL Editor
4. Create a new query
5. Paste this entire script
6. Click "Run" or press Ctrl+Enter

================================================================================
SQL SCRIPT STARTS BELOW
================================================================================

-- Update Subscription System for BOTH Companies AND Professionals
-- This script provides 6 months FREE Premium subscription to ALL new sign-ups

BEGIN;

-- ============================================
-- PART 1: COMPANY SUBSCRIPTION PLANS
-- ============================================

-- Clear existing company plans
DELETE FROM public.subscription_plans WHERE user_type = 'company';

-- Insert company subscription plans
INSERT INTO public.subscription_plans (name, user_type, price, duration_days, job_limit, contact_limit, features, active) VALUES
(
    'Starter Plan',
    'company',
    0.00,
    2147483647, -- Max integer for "permanent"
    5,
    10,
    '{
        "description": "Perfect for small companies - free forever",
        "support": "standard",
        "job_posting": "5 per month",
        "professional_contact": "10 per month",
        "map_search": true,
        "basic_analytics": true
    }',
    true
),
(
    'Premium Plan',
    'company',
    10.00,
    30,
    NULL,
    NULL,
    '{
        "description": "Unlimited access for growing companies",
        "support": "priority",
        "job_posting": "unlimited",
        "professional_contact": "unlimited",
        "advanced_search": true,
        "analytics_dashboard": true,
        "priority_placement": true,
        "featured_jobs": true
    }',
    true
);

-- ============================================
-- PART 2: PROFESSIONAL SUBSCRIPTION PLANS
-- ============================================

-- Clear existing professional plans
DELETE FROM public.subscription_plans WHERE user_type = 'professional';

-- Insert professional subscription plans
INSERT INTO public.subscription_plans (name, user_type, price, duration_days, job_limit, contact_limit, features, active) VALUES
(
    'Basic Plan',
    'professional',
    0.00,
    2147483647, -- Max integer for "permanent"
    NULL, -- Professionals don't post jobs
    NULL, -- Professionals don't contact other professionals
    '{
        "description": "Standard profile visibility - free forever",
        "support": "standard",
        "profile_visibility": "standard",
        "actively_looking_toggle": false,
        "bold_name": false,
        "priority_ranking": false,
        "green_indicator": false
    }',
    true
),
(
    'Premium Plan',
    'professional',
    5.00,
    30,
    NULL,
    NULL,
    '{
        "description": "Enhanced visibility and professional tools",
        "support": "priority",
        "profile_visibility": "enhanced",
        "actively_looking_toggle": true,
        "bold_name": true,
        "priority_ranking": true,
        "green_indicator": true,
        "featured_profile": true,
        "analytics_access": true
    }',
    true
);

-- ============================================
-- PART 3: AUTO-ASSIGNMENT FUNCTION
-- ============================================

-- Create function to automatically assign 6-month Premium to ALL new users
CREATE OR REPLACE FUNCTION public.assign_premium_subscription_on_signup()
RETURNS TRIGGER AS $$
DECLARE
    basic_plan_id UUID;
    premium_plan_id UUID;
    premium_end_date TIMESTAMP WITH TIME ZONE;
    basic_start_date TIMESTAMP WITH TIME ZONE;
BEGIN
    -- Only process company and professional user types
    IF NEW.user_type NOT IN ('company', 'professional') THEN
        RETURN NEW;
    END IF;

    -- Get the appropriate plan IDs based on user type
    IF NEW.user_type = 'company' THEN
        -- Get company plans
        SELECT id INTO basic_plan_id
        FROM public.subscription_plans
        WHERE name = 'Starter Plan' AND user_type = 'company'
        LIMIT 1;

        SELECT id INTO premium_plan_id
        FROM public.subscription_plans
        WHERE name = 'Premium Plan' AND user_type = 'company'
        LIMIT 1;
    ELSE
        -- Get professional plans
        SELECT id INTO basic_plan_id
        FROM public.subscription_plans
        WHERE name = 'Basic Plan' AND user_type = 'professional'
        LIMIT 1;

        SELECT id INTO premium_plan_id
        FROM public.subscription_plans
        WHERE name = 'Premium Plan' AND user_type = 'professional'
        LIMIT 1;
    END IF;

    -- ALL USERS GET 6 MONTHS FREE PREMIUM AS SIGNUP BONUS
    premium_end_date := NOW() + INTERVAL '6 months';
    basic_start_date := premium_end_date; -- Basic/Starter begins when premium ends

    -- First: Create 6-month Premium subscription (signup bonus)
    INSERT INTO public.user_subscriptions (
        user_id,
        plan_id,
        start_date,
        end_date,
        jobs_used,
        contacts_used,
        status,
        payment_data
    ) VALUES (
        NEW.id,
        premium_plan_id,
        NOW(),
        premium_end_date,
        0,
        0,
        'active',
        CASE
            WHEN NEW.user_type = 'company' THEN
                jsonb_build_object(
                    'type', 'signup_bonus',
                    'reason', 'new_company_promotion',
                    'welcome_message', 'ðŸŽ‰ Congratulations! You now have a free 6-month subscription! With this gift, you can: Post unlimited jobs, Contact unlimited people, Enjoy priority listing in search results',
                    'is_promotional', true,
                    'auto_downgrade_to', 'Starter Plan',
                    'auto_downgrade_date', premium_end_date
                )
            ELSE
                jsonb_build_object(
                    'type', 'signup_bonus',
                    'reason', 'new_professional_promotion',
                    'welcome_message', 'Congratulations! You''ve been upgraded to a 6-month premium subscription. Enjoy enhanced visibility and tools to boost your professional presence: "Actively Looking" toggle, Bold profile name, Priority search ranking, Green visibility indicator, Enhanced profile features',
                    'is_promotional', true,
                    'auto_downgrade_to', 'Basic Plan',
                    'auto_downgrade_date', premium_end_date
                )
        END
    );

    -- Second: Create Basic/Starter Plan subscription (scheduled to start when premium ends)
    INSERT INTO public.user_subscriptions (
        user_id,
        plan_id,
        start_date,
        end_date,
        jobs_used,
        contacts_used,
        status,
        payment_data
    ) VALUES (
        NEW.id,
        basic_plan_id,
        basic_start_date,
        basic_start_date + INTERVAL '100 years', -- Effectively permanent
        0,
        0,
        'scheduled', -- Will become active when premium expires
        CASE
            WHEN NEW.user_type = 'company' THEN
                jsonb_build_object(
                    'type', 'auto_assigned',
                    'reason', 'post_promotion_default',
                    'welcome_message', 'Your free Premium period has ended. You are now on our free Starter Plan.',
                    'activated_from_promotion', true
                )
            ELSE
                jsonb_build_object(
                    'type', 'auto_assigned',
                    'reason', 'post_promotion_default',
                    'welcome_message', 'Your free Premium period has ended. You are now on our free Basic Plan.',
                    'activated_from_promotion', true
                )
        END
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop old trigger if exists
DROP TRIGGER IF EXISTS auto_assign_subscription_on_signup ON public.users;
DROP TRIGGER IF EXISTS auto_assign_premium_subscription_on_signup ON public.users;

-- Create new trigger to auto-assign subscription on user creation
CREATE TRIGGER auto_assign_premium_subscription_on_signup
    AFTER INSERT ON public.users
    FOR EACH ROW
    EXECUTE FUNCTION public.assign_premium_subscription_on_signup();

-- ============================================
-- PART 4: HELPER FUNCTIONS (if not exist)
-- ============================================

-- Function to get user's welcome message
CREATE OR REPLACE FUNCTION public.get_user_welcome_message(user_id_param UUID)
RETURNS TEXT AS $$
DECLARE
    welcome_msg TEXT;
BEGIN
    SELECT us.payment_data->>'welcome_message' INTO welcome_msg
    FROM public.user_subscriptions us
    WHERE us.user_id = user_id_param
      AND us.status = 'active'
      AND us.payment_data->>'type' = 'signup_bonus'
    ORDER BY us.created_at DESC
    LIMIT 1;

    RETURN welcome_msg;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to check if user should see welcome message
CREATE OR REPLACE FUNCTION public.should_show_welcome_message(user_id_param UUID)
RETURNS BOOLEAN AS $$
DECLARE
    has_seen_welcome BOOLEAN;
BEGIN
    -- Check if user has a subscription with welcome message that hasn't been shown
    SELECT CASE
        WHEN us.payment_data->>'welcome_shown' = 'true' THEN false
        WHEN us.payment_data->>'welcome_message' IS NOT NULL THEN true
        ELSE false
    END INTO has_seen_welcome
    FROM public.user_subscriptions us
    WHERE us.user_id = user_id_param
      AND us.status = 'active'
      AND us.payment_data->>'type' = 'signup_bonus'
    ORDER BY us.created_at DESC
    LIMIT 1;

    RETURN COALESCE(has_seen_welcome, false);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to mark welcome message as shown
CREATE OR REPLACE FUNCTION public.mark_welcome_message_shown(user_id_param UUID)
RETURNS BOOLEAN AS $$
BEGIN
    UPDATE public.user_subscriptions
    SET payment_data = payment_data || jsonb_build_object('welcome_shown', 'true'),
        updated_at = NOW()
    WHERE user_id = user_id_param
      AND status = 'active'
      AND payment_data->>'type' = 'signup_bonus'
      AND payment_data->>'welcome_shown' != 'true';

    RETURN true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to process expired subscriptions
CREATE OR REPLACE FUNCTION public.process_expired_subscriptions()
RETURNS INTEGER AS $$
DECLARE
    expired_count INTEGER := 0;
    expired_sub RECORD;
BEGIN
    -- Process all expired promotional subscriptions
    FOR expired_sub IN
        SELECT us.id, us.user_id, us.payment_data
        FROM public.user_subscriptions us
        WHERE us.status = 'active'
          AND us.end_date <= NOW()
          AND us.payment_data->>'is_promotional' = 'true'
          AND us.payment_data->>'type' = 'signup_bonus'
    LOOP
        -- Mark promotional subscription as expired
        UPDATE public.user_subscriptions
        SET status = 'expired',
            updated_at = NOW()
        WHERE id = expired_sub.id;

        -- Activate the scheduled basic/starter plan
        UPDATE public.user_subscriptions
        SET status = 'active',
            start_date = NOW(),
            updated_at = NOW()
        WHERE user_id = expired_sub.user_id
          AND status = 'scheduled'
          AND payment_data->>'activated_from_promotion' = 'true';

        expired_count := expired_count + 1;
    END LOOP;

    RETURN expired_count;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- PART 5: GRANT PERMISSIONS
-- ============================================

GRANT EXECUTE ON FUNCTION public.assign_premium_subscription_on_signup() TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_user_welcome_message(UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION public.should_show_welcome_message(UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION public.mark_welcome_message_shown(UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION public.process_expired_subscriptions() TO authenticated;

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user_id_status ON public.user_subscriptions(user_id, status);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_payment_data ON public.user_subscriptions USING GIN(payment_data);

COMMIT;

-- Success message
DO $$
BEGIN
    RAISE NOTICE '============================================';
    RAISE NOTICE 'SUBSCRIPTION SYSTEM UPDATE COMPLETE!';
    RAISE NOTICE '============================================';
    RAISE NOTICE 'Features:';
    RAISE NOTICE 'âœ“ Company Plans: Starter (Free) + Premium (Â£10/month)';
    RAISE NOTICE 'âœ“ Professional Plans: Basic (Free) + Premium (Â£5/month)';
    RAISE NOTICE 'âœ“ 6-Month Premium Bonus: ALL new users get 6 months FREE Premium!';
    RAISE NOTICE 'âœ“ Auto-downgrade: After 6 months, users move to free tier';
    RAISE NOTICE 'âœ“ Welcome Messages: Customized for companies vs professionals';
    RAISE NOTICE '============================================';
    RAISE NOTICE 'Company Premium Benefits:';
    RAISE NOTICE 'â€¢ Post unlimited jobs';
    RAISE NOTICE 'â€¢ Contact unlimited professionals';
    RAISE NOTICE 'â€¢ Priority listing in search results';
    RAISE NOTICE '============================================';
    RAISE NOTICE 'Professional Premium Benefits:';
    RAISE NOTICE 'â€¢ "Actively Looking" toggle';
    RAISE NOTICE 'â€¢ Bold profile name';
    RAISE NOTICE 'â€¢ Priority search ranking';
    RAISE NOTICE 'â€¢ Green visibility indicator';
    RAISE NOTICE 'â€¢ Enhanced profile features';
    RAISE NOTICE '============================================';
END $$;

================================================================================
END OF SQL SCRIPT
================================================================================

WHAT THIS DOES:
âœ“ Creates subscription plans for companies and professionals
âœ“ Sets up automatic 6-month FREE Premium for all new sign-ups
âœ“ Creates welcome modals with congratulations messages
âœ“ Automatically downgrades to free tier after 6 months

NEXT STEPS AFTER RUNNING THIS:
1. Test by creating a new company account
2. Test by creating a new professional account
3. Both should see congratulations modals
4. Check subscriptions in database to verify
